{% extends "unfold/layouts/base.html" %}
{% load i18n unfold static %}

{% block title %}TPS Dashboard{% endblock %}

{% block content %}
<style>
  
    .stat-card, .activity-container {
        background: transparent !important;
        box-shadow: none !important;
        border: none !important;
        padding: 0 !important;
    }

 
    .insight-number {
        font-size: 3.5rem;
        font-weight: 800;
        line-height: 1;
        margin-bottom: 0.5rem;
    }
    .insight-label {
        font-size: 0.95rem;
        font-weight: 600;
        color: #6b7280; 
    }
    .insight-sub {
        font-size: 0.8rem;
        font-weight: 700;
        margin-top: 5px;
        opacity: 0.9;
    }
    
  
    .text-neon-blue { color: #3b82f6; }

    .text-neon-orange { color: #f59e0b; }
 
    .text-neon-green { color: #10b981; }

    .text-neon-red { color: #ef4444; }

   
    .shortcut-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr); 
        gap: 1.25rem;
    }

    .shortcut-btn {
        display: flex;
        flex-direction: column;
        justify-content: center;
        padding: 24px 28px;
        border-radius: 16px; 
        text-decoration: none;
        transition: transform 0.2s, box-shadow 0.2s, filter 0.2s;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); 
        color: white !important; 
        min-height: 100px;
    }
    
    .shortcut-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        filter: brightness(1.05); 
    }

    .shortcut-title {
        font-size: 1.3rem; 
        font-weight: 700;
        margin-bottom: 4px;
        display: block;
        text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .shortcut-desc {
        font-size: 0.85rem;
        font-weight: 500;
        opacity: 0.85;
        display: block;
    }

 
    .grad-user { background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 100%); }

    .grad-manager { background: linear-gradient(90deg, #ec4899 0%, #f472b6 100%); }

    .grad-patroller { background: linear-gradient(90deg, #22c55e 0%, #06b6d4 100%); }
 
    .grad-admin { background: linear-gradient(90deg, #a855f7 0%, #d946ef 100%); }

    .grad-city { background: linear-gradient(90deg, #f43f5e 0%, #fbbf24 100%); }

    .grad-parking { background: linear-gradient(90deg, #facc15 0%, #f97316 100%); }
 
    .grad-manage { background: linear-gradient(90deg, #2563eb 0%, #38bdf8 100%); }
 
    .grad-violation { background: linear-gradient(90deg, #ef4444 0%, #f87171 100%); }


    /* 4. Recent Activity */
    .activity-item {
        padding: 16px 0;
        border-bottom: 1px solid #e5e7eb;
        position: relative;
    }
    .activity-item:last-child { border-bottom: none; }
    .avatar-circle {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 1rem;
        background-color: #eff6ff;
        color: #3b82f6;
        margin-right: 22px; /* Aggiunto spazio extra */
    }
    .activity-main-content {
        display: flex;
        flex: 1;
        min-width: 0;
        align-items: flex-start;
    }
    .activity-amount {
        position: absolute;
        top: 0;
        right: 0;
        font-weight: bold;
        font-size: 1.1rem;
        padding: 0.5rem 1rem 0 1rem;
        z-index: 2;
        background: transparent;
        /* Colore dinamico via classe */
    }
    
    .dark .insight-label { color: #9ca3af; } 
    .dark .activity-item { border-bottom-color: #374151; }
    .dark .avatar-circle { background-color: rgba(59, 130, 246, 0.2); color: #60a5fa; }
    
    .dark .text-neon-blue { color: #60a5fa; }
    .dark .text-neon-orange { color: #fbbf24; }
    .dark .text-neon-green { color: #34d399; }
    .dark .text-neon-red { color: #f87171; }

</style>

<div class="px-6 py-8">
    
    <div class="mb-10">
        <h1 style="font-size: 2.5rem;" class="font-extrabold text-gray-900 dark:text-white tracking-tight">
            Welcome back, <span class="text-neon-blue">{{ request.user.first_name|default:request.user.username }}!</span>
        </h1>
    </div>

    <div class="mb-12">
        <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-6">Insights</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
            
            <div class="stat-card">
                <div class="insight-number text-neon-blue">{{ stats.total_users|default:"0" }}</div>
                <div class="insight-label">Total Users</div>
                <div class="insight-sub text-neon-blue">+{{ stats.new_users_today|default:"0" }} Today</div>
            </div>

            <div class="stat-card">
                <div class="insight-number text-neon-orange">{{ stats.active_sessions|default:"0" }}</div>
                <div class="insight-label">Active Sessions</div>
                <div class="insight-sub text-neon-orange flex items-center gap-2">
                    Live
                </div>
            </div>

            <div class="stat-card">
                <div class="insight-number text-neon-green">€{{ stats.all_revenue|default:"0.00" }}</div>
                <div class="insight-label">All Time Revenue</div>
                <div class="insight-sub text-neon-green">+€{{ stats.today_revenue|default:"0.00" }} Today</div>
            </div>

            <div class="stat-card">
                <div class="insight-number text-neon-red">{{ stats.active_violations_count|default:"0" }}</div>
                <div class="insight-label">Active Violations</div>
                <div class="insight-sub text-neon-orange" style="font-weight: 800;">{{ stats.pending_disputes|default:"0" }} Pending </div>
            </div>
        </div>
    </div>

    

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-12">
        <div class="lg:col-span-2">
            <div class="dark:bg-gray-800 rounded-lg p-6 pl-0">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-6">System Global Rules</h3>
                    <div class="flex justify-between items-center mb-4">
                        {% if system_config.id %}
                            <a href="/admin/vehicles/globalsettings/{{ system_config.id }}/change/" class="text-sm text-blue-500 font-semibold hover:underline">
                                Update Rules &rarr;
                            </a>
                        {% else %}
                            <a href="/admin/vehicles/globalsettings/add/" class="text-sm text-green-500 font-semibold hover:underline">
                                Initialize Rules &rarr;
                            </a>
                        {% endif %}
                    </div>
                </div>
                <div class="flex flex-wrap gap-3 mb-6">
                    <div class="px-4 py-2 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 rounded-full text-sm font-bold">
                        Max Violations: {{ system_config.max_violations|default:"3" }}
                    </div>
                    <div class="px-4 py-2 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 rounded-full text-sm font-bold">
                        Grace Period: {{ system_config.grace_period_minutes|default:"15" }} min
                    </div>
                </div>
                
                <div>
                    <div class="bg-gray-50 dark:bg-gray-700/30 rounded-lg px-4">
                        <h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-3">
                            Violation cases and fines
                        </h4>
                        <hr class="border-gray-200 dark:border-gray-600" />
                        {% if violation_types %}
                            {% for tariff in violation_types %}
                            <div class="flex justify-between text-sm border-b border-gray-200 dark:border-gray-600 py-3 {% if forloop.last %}border-0{% endif %}">
                                <span class="font-medium text-gray-700 dark:text-gray-300">
                                    {{ tariff.name }}
                                </span>
                                <span class="font-bold text-gray-900 dark:text-white">
                                    €{{ tariff.amount }}
                                </span>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center text-gray-400 text-xs italic py-3">
                                No tariff configured
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-6">Shortcuts</h3>
            
            <div class="shortcut-grid">
                <a href="/admin/users/customuser/add/" class="shortcut-btn grad-user">
                    <span class="shortcut-title">Add User</span>
                    <span class="shortcut-desc">Create new customer account</span>
                </a>

                <a href="/admin/users/customuser/add/?role=manager" class="shortcut-btn grad-manager">
                    <span class="shortcut-title">Add Manager</span>
                    <span class="shortcut-desc">Create new manager</span>
                </a>

                <a href="/admin/users/customuser/add/?role=officer" class="shortcut-btn grad-patroller">
                    <span class="shortcut-title">Add Patroller</span>
                    <span class="shortcut-desc">Register new patroller</span>
                </a>

                <a href="/admin/users/customuser/add/?role=admin" class="shortcut-btn grad-admin">
                    <span class="shortcut-title">Add Admin</span>
                    <span class="shortcut-desc">Create new admin</span>
                </a>

                <a href="/admin/parkings/city/add/" class="shortcut-btn grad-city">
                    <span class="shortcut-title">Add City</span>
                    <span class="shortcut-desc">Register new city</span>
                </a>

                <a href="/admin/parkings/parking/add/" class="shortcut-btn grad-parking">
                    <span class="shortcut-title">Add Parking</span>
                    <span class="shortcut-desc">Create parking lot</span>
                </a>

                <a href="/admin/users/customuser/?role__exact=officer" class="shortcut-btn grad-manage">
                     <span class="shortcut-title">Manage Patrollers</span>
                     <span class="shortcut-desc">View all patrollers</span>
                </a>

                <a href="/admin/vehicles/fine/" class="shortcut-btn grad-violation">
                    <span class="shortcut-title">Check Violations</span>
                    <span class="shortcut-desc">View all outstanding fines</span>
                </a>
            </div>
        </div>
        
        <div class="lg:col-span-1">
             <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-900 dark:text-white">Recent Activity</h3>
             </div>
             
             <div class="activity-container">
                {% if recent_activity %}
                    <div>
                        {% for item in recent_activity %}
                        <div class="activity-item">
                            <div class="activity-main-content">
                                <div class="flex-shrink-0">
                                    {% if item.type == 'user' %}
                                        <div class="avatar-circle" style="background-color: rgba(59, 130, 246, 0.15); color: #3b82f6; font-family: sans-serif;">
                                            U
                                        </div>
                                    {% elif item.type == 'session' %}
                                        <div class="avatar-circle" style="background-color: rgba(245, 158, 11, 0.15); color: #f59e0b; font-family: sans-serif;">
                                            P
                                        </div>
                                    {% elif item.type == 'fine_payment' %}
                                        <div class="avatar-circle" style="background-color: rgba(16, 185, 129, 0.15); color: #10b981; font-family: sans-serif;">
                                            €
                                        </div>
                                    {% elif item.type == 'fine_issued' %}
                                        <div class="avatar-circle" style="background-color: rgba(239, 68, 68, 0.15); color: #ef4444; font-family: sans-serif;">
                                            V
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-bold text-gray-900 dark:text-white truncate">
                                        {{ item.title }}
                                    </p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5 truncate">
                                        {{ item.identifier }}
                                    </p>
                                    <p class="text-xs text-gray-400 mt-1 font-mono">
                                        {{ item.timestamp|timesince }} ago
                                    </p>
                                </div>
                            </div>
                            {% if item.amount %}
                                {% if item.type == 'fine_issued' %}
                                    <div class="activity-amount text-neon-red">
                                        €{{ item.amount }}
                                    </div>
                                {% else %}
                                    <div class="activity-amount text-neon-green">
                                        +€{{ item.amount }}
                                    </div>
                                {% endif %}
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="py-8 text-center text-gray-500 italic">
                        No recent activity found.
                    </div>
                {% endif %}
             </div>
        </div>
    </div>
</div>
{% endblock %}